import React, { useState, useEffect } from 'react';
import { CreditCard, Plus, DollarSign, Calendar, Trash2, Edit3, Check, X } from 'lucide-react';

const CreditCardTracker = () => {
  const [cards, setCards] = useState([]);
  const [transactions, setTransactions] = useState([]);
  const [activeTab, setActiveTab] = useState('cards');
  const [showAddCard, setShowAddCard] = useState(false);
  const [showAddTransaction, setShowAddTransaction] = useState(false);
  const [editingCard, setEditingCard] = useState(null);

  // Load data from localStorage on component mount
  useEffect(() => {
    const savedCards = JSON.parse(localStorage.getItem('creditCards') || '[]');
    const savedTransactions = JSON.parse(localStorage.getItem('transactions') || '[]');
    setCards(savedCards);
    setTransactions(savedTransactions);
  }, []);

  // Save to localStorage whenever data changes
  useEffect(() => {
    localStorage.setItem('creditCards', JSON.stringify(cards));
  }, [cards]);

  useEffect(() => {
    localStorage.setItem('transactions', JSON.stringify(transactions));
  }, [transactions]);

  const [newCard, setNewCard] = useState({
    name: '',
    lastFourDigits: '',
    creditLimit: '',
    currentBalance: '',
    dueDate: '',
    color: '#3B82F6'
  });

  const [newTransaction, setNewTransaction] = useState({
    cardId: '',
    description: '',
    amount: '',
    type: 'expense',
    category: 'general',
    date: new Date().toISOString().split('T')[0]
  });

  const cardColors = [
    '#3B82F6', '#EF4444', '#10B981', '#F59E0B', 
    '#8B5CF6', '#EC4899', '#06B6D4', '#84CC16'
  ];

  const categories = [
    'general', 'food', 'shopping', 'transport', 'entertainment', 
    'bills', 'fuel', 'medical', 'travel', 'other'
  ];

  const addCard = () => {
    if (!newCard.name || !newCard.lastFourDigits) return;
    
    const card = {
      id: Date.now().toString(),
      ...newCard,
      creditLimit: parseFloat(newCard.creditLimit) || 0,
      currentBalance: parseFloat(newCard.currentBalance) || 0,
      createdAt: new Date().toISOString()
    };
    
    setCards([...cards, card]);
    setNewCard({
      name: '',
      lastFourDigits: '',
      creditLimit: '',
      currentBalance: '',
      dueDate: '',
      color: '#3B82F6'
    });
    setShowAddCard(false);
  };

  const deleteCard = (cardId) => {
    setCards(cards.filter(card => card.id !== cardId));
    setTransactions(transactions.filter(t => t.cardId !== cardId));
  };

  const updateCard = (cardId, updates) => {
    setCards(cards.map(card => 
      card.id === cardId ? { ...card, ...updates } : card
    ));
    setEditingCard(null);
  };

  const addTransaction = () => {
    if (!newTransaction.cardId || !newTransaction.description || !newTransaction.amount) return;
    
    const transaction = {
      id: Date.now().toString(),
      ...newTransaction,
      amount: parseFloat(newTransaction.amount),
      createdAt: new Date().toISOString()
    };
    
    setTransactions([transaction, ...transactions]);
    
    // Update card balance
    const updatedCards = cards.map(card => {
      if (card.id === newTransaction.cardId) {
        const balanceChange = newTransaction.type === 'expense' 
          ? parseFloat(newTransaction.amount) 
          : -parseFloat(newTransaction.amount);
        return {
          ...card,
          currentBalance: card.currentBalance + balanceChange
        };
      }
      return card;
    });
    setCards(updatedCards);
    
    setNewTransaction({
      cardId: '',
      description: '',
      amount: '',
      type: 'expense',
      category: 'general',
      date: new Date().toISOString().split('T')[0]
    });
    setShowAddTransaction(false);
  };

  const payBill = (cardId, amount) => {
    const paymentAmount = parseFloat(amount);
    if (!paymentAmount || paymentAmount <= 0) return;

    // Add payment transaction
    const payment = {
      id: Date.now().toString(),
      cardId,
      description: 'Bill Payment',
      amount: paymentAmount,
      type: 'payment',
      category: 'payment',
      date: new Date().toISOString().split('T')[0],
      createdAt: new Date().toISOString()
    };
    
    setTransactions([payment, ...transactions]);
    
    // Update card balance
    setCards(cards.map(card => 
      card.id === cardId 
        ? { ...card, currentBalance: Math.max(0, card.currentBalance - paymentAmount) }
        : card
    ));
  };

  const getCardTransactions = (cardId) => {
    return transactions.filter(t => t.cardId === cardId);
  };

  const getUtilizationPercentage = (card) => {
    return card.creditLimit > 0 ? (card.currentBalance / card.creditLimit) * 100 : 0;
  };

  const CardComponent = ({ card }) => {
    const [paymentAmount, setPaymentAmount] = useState('');
    const [showPayment, setShowPayment] = useState(false);
    const utilization = getUtilizationPercentage(card);
    const cardTransactions = getCardTransactions(card.id);

    return (
      <div className="bg-white rounded-xl shadow-lg p-6 mb-4">
        <div 
          className="w-full h-48 rounded-lg mb-4 p-4 text-white relative overflow-hidden"
          style={{ backgroundColor: card.color }}
        >
          <div className="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent"></div>
          <div className="relative z-10">
            <div className="flex justify-between items-start mb-8">
              <CreditCard size={32} />
              <div className="flex gap-2">
                <button
                  onClick={() => setEditingCard(card.id)}
                  className="p-1 bg-white/20 rounded hover:bg-white/30"
                >
                  <Edit3 size={16} />
                </button>
                <button
                  onClick={() => deleteCard(card.id)}
                  className="p-1 bg-white/20 rounded hover:bg-white/30"
                >
                  <Trash2 size={16} />
                </button>
              </div>
            </div>
            <div className="text-lg font-semibold mb-2">{card.name}</div>
            <div className="text-sm opacity-90">**** **** **** {card.lastFourDigits}</div>
            <div className="text-xl font-bold mt-4">₹{card.currentBalance.toLocaleString()}</div>
            <div className="text-sm opacity-90">of ₹{card.creditLimit.toLocaleString()}</div>
          </div>
        </div>

        <div className="space-y-3">
          <div className="flex justify-between text-sm">
            <span>Utilization</span>
            <span className={utilization > 80 ? 'text-red-500 font-semibold' : 'text-gray-600'}>
              {utilization.toFixed(1)}%
            </span>
          </div>
          
          <div className="w-full bg-gray-200 rounded-full h-2">
            <div 
              className={`h-2 rounded-full transition-all ${
                utilization > 80 ? 'bg-red-500' : utilization > 60 ? 'bg-yellow-500' : 'bg-green-500'
              }`}
              style={{ width: `${Math.min(utilization, 100)}%` }}
            ></div>
          </div>

          {card.dueDate && (
            <div className="flex justify-between text-sm">
              <span>Due Date</span>
              <span>{new Date(card.dueDate).toLocaleDateString()}</span>
            </div>
          )}

          <div className="flex gap-2 mt-4">
            <button
              onClick={() => setShowPayment(!showPayment)}
              className="flex-1 bg-green-500 text-white py-2 px-4 rounded-lg font-medium hover:bg-green-600 transition-colors"
            >
              Pay Bill
            </button>
          </div>

          {showPayment && (
            <div className="mt-4 p-4 bg-gray-50 rounded-lg">
              <div className="flex gap-2">
                <input
                  type="number"
                  placeholder="Payment amount"
                  value={paymentAmount}
                  onChange={(e) => setPaymentAmount(e.target.value)}
                  className="flex-1 p-2 border border-gray-300 rounded-lg"
                />
                <button
                  onClick={() => {
                    payBill(card.id, paymentAmount);
                    setPaymentAmount('');
                    setShowPayment(false);
                  }}
                  className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600"
                >
                  <Check size={16} />
                </button>
                <button
                  onClick={() => {
                    setShowPayment(false);
                    setPaymentAmount('');
                  }}
                  className="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600"
                >
                  <X size={16} />
                </button>
              </div>
            </div>
          )}

          <div className="text-sm text-gray-600">
            {cardTransactions.length} transactions
          </div>
        </div>
      </div>
    );
  };

  const EditCardModal = ({ card }) => {
    const [editData, setEditData] = useState(card);

    return (
      <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
        <div className="bg-white rounded-xl p-6 w-full max-w-md">
          <h3 className="text-lg font-semibold mb-4">Edit Card</h3>
          <div className="space-y-4">
            <input
              type="text"
              placeholder="Card Name"
              value={editData.name}
              onChange={(e) => setEditData({...editData, name: e.target.value})}
              className="w-full p-3 border border-gray-300 rounded-lg"
            />
            <input
              type="number"
              placeholder="Credit Limit"
              value={editData.creditLimit}
              onChange={(e) => setEditData({...editData, creditLimit: e.target.value})}
              className="w-full p-3 border border-gray-300 rounded-lg"
            />
            <input
              type="number"
              placeholder="Current Balance"
              value={editData.currentBalance}
              onChange={(e) => setEditData({...editData, currentBalance: e.target.value})}
              className="w-full p-3 border border-gray-300 rounded-lg"
            />
            <input
              type="date"
              value={editData.dueDate}
              onChange={(e) => setEditData({...editData, dueDate: e.target.value})}
              className="w-full p-3 border border-gray-300 rounded-lg"
            />
            <div className="flex gap-2 flex-wrap">
              {cardColors.map(color => (
                <button
                  key={color}
                  onClick={() => setEditData({...editData, color})}
                  className={`w-8 h-8 rounded-full border-2 ${
                    editData.color === color ? 'border-gray-800' : 'border-gray-300'
                  }`}
                  style={{ backgroundColor: color }}
                />
              ))}
            </div>
            <div className="flex gap-2">
              <button
                onClick={() => {
                  updateCard(card.id, {
                    ...editData,
                    creditLimit: parseFloat(editData.creditLimit) || 0,
                    currentBalance: parseFloat(editData.currentBalance) || 0
                  });
                }}
                className="flex-1 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600"
              >
                Save
              </button>
              <button
                onClick={() => setEditingCard(null)}
                className="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-gray-100">
      {/* Header */}
      <div className="bg-white shadow-sm p-4">
        <h1 className="text-2xl font-bold text-center text-gray-800">Credit Card Tracker</h1>
      </div>

      {/* Tab Navigation */}
      <div className="bg-white border-b">
        <div className="flex">
          <button
            onClick={() => setActiveTab('cards')}
            className={`flex-1 py-3 text-center font-medium ${
              activeTab === 'cards' 
                ? 'text-blue-600 border-b-2 border-blue-600' 
                : 'text-gray-500'
            }`}
          >
            Cards
          </button>
          <button
            onClick={() => setActiveTab('transactions')}
            className={`flex-1 py-3 text-center font-medium ${
              activeTab === 'transactions' 
                ? 'text-blue-600 border-b-2 border-blue-600' 
                : 'text-gray-500'
            }`}
          >
            Transactions
          </button>
        </div>
      </div>

      {/* Content */}
      <div className="p-4">
        {activeTab === 'cards' && (
          <div>
            {/* Add Card Button */}
            <button
              onClick={() => setShowAddCard(true)}
              className="w-full bg-blue-500 text-white py-3 px-4 rounded-lg mb-6 flex items-center justify-center gap-2 hover:bg-blue-600 transition-colors"
            >
              <Plus size={20} />
              Add New Card
            </button>

            {/* Cards List */}
            {cards.length === 0 ? (
              <div className="text-center py-12 text-gray-500">
                <CreditCard size={48} className="mx-auto mb-4 opacity-50" />
                <p>No credit cards added yet</p>
              </div>
            ) : (
              cards.map(card => <CardComponent key={card.id} card={card} />)
            )}

            {/* Add Card Modal */}
            {showAddCard && (
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-xl p-6 w-full max-w-md">
                  <h3 className="text-lg font-semibold mb-4">Add New Card</h3>
                  <div className="space-y-4">
                    <input
                      type="text"
                      placeholder="Card Name (e.g., HDFC Regalia)"
                      value={newCard.name}
                      onChange={(e) => setNewCard({...newCard, name: e.target.value})}
                      className="w-full p-3 border border-gray-300 rounded-lg"
                    />
                    <input
                      type="text"
                      placeholder="Last 4 digits"
                      maxLength="4"
                      value={newCard.lastFourDigits}
                      onChange={(e) => setNewCard({...newCard, lastFourDigits: e.target.value.replace(/\D/g, '')})}
                      className="w-full p-3 border border-gray-300 rounded-lg"
                    />
                    <input
                      type="number"
                      placeholder="Credit Limit"
                      value={newCard.creditLimit}
                      onChange={(e) => setNewCard({...newCard, creditLimit: e.target.value})}
                      className="w-full p-3 border border-gray-300 rounded-lg"
                    />
                    <input
                      type="number"
                      placeholder="Current Balance"
                      value={newCard.currentBalance}
                      onChange={(e) => setNewCard({...newCard, currentBalance: e.target.value})}
                      className="w-full p-3 border border-gray-300 rounded-lg"
                    />
                    <input
                      type="date"
                      value={newCard.dueDate}
                      onChange={(e) => setNewCard({...newCard, dueDate: e.target.value})}
                      className="w-full p-3 border border-gray-300 rounded-lg"
                    />
                    <div>
                      <p className="text-sm text-gray-600 mb-2">Choose card color:</p>
                      <div className="flex gap-2 flex-wrap">
                        {cardColors.map(color => (
                          <button
                            key={color}
                            onClick={() => setNewCard({...newCard, color})}
                            className={`w-8 h-8 rounded-full border-2 ${
                              newCard.color === color ? 'border-gray-800' : 'border-gray-300'
                            }`}
                            style={{ backgroundColor: color }}
                          />
                        ))}
                      </div>
                    </div>
                    <div className="flex gap-2">
                      <button
                        onClick={addCard}
                        className="flex-1 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600"
                      >
                        Add Card
                      </button>
                      <button
                        onClick={() => setShowAddCard(false)}
                        className="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600"
                      >
                        Cancel
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Edit Card Modal */}
            {editingCard && (
              <EditCardModal card={cards.find(c => c.id === editingCard)} />
            )}
          </div>
        )}

        {activeTab === 'transactions' && (
          <div>
            {/* Add Transaction Button */}
            <button
              onClick={() => setShowAddTransaction(true)}
              className="w-full bg-green-500 text-white py-3 px-4 rounded-lg mb-6 flex items-center justify-center gap-2 hover:bg-green-600 transition-colors"
            >
              <Plus size={20} />
              Add Transaction
            </button>

            {/* Transactions List */}
            {transactions.length === 0 ? (
              <div className="text-center py-12 text-gray-500">
                <DollarSign size={48} className="mx-auto mb-4 opacity-50" />
                <p>No transactions recorded yet</p>
              </div>
            ) : (
              <div className="space-y-3">
                {transactions.map(transaction => {
                  const card = cards.find(c => c.id === transaction.cardId);
                  return (
                    <div key={transaction.id} className="bg-white rounded-lg p-4 shadow-sm">
                      <div className="flex justify-between items-start mb-2">
                        <div>
                          <div className="font-medium">{transaction.description}</div>
                          <div className="text-sm text-gray-500">
                            {card?.name || 'Unknown Card'} • {transaction.category}
                          </div>
                        </div>
                        <div className={`font-semibold ${
                          transaction.type === 'expense' ? 'text-red-500' : 'text-green-500'
                        }`}>
                          {transaction.type === 'expense' ? '+' : '-'}₹{transaction.amount.toLocaleString()}
                        </div>
                      </div>
                      <div className="text-xs text-gray-400">
                        {new Date(transaction.date).toLocaleDateString()}
                      </div>
                    </div>
                  );
                })}
              </div>
            )}

            {/* Add Transaction Modal */}
            {showAddTransaction && (
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-xl p-6 w-full max-w-md">
                  <h3 className="text-lg font-semibold mb-4">Add Transaction</h3>
                  <div className="space-y-4">
                    <select
                      value={newTransaction.cardId}
                      onChange={(e) => setNewTransaction({...newTransaction, cardId: e.target.value})}
                      className="w-full p-3 border border-gray-300 rounded-lg"
                    >
                      <option value="">Select Card</option>
                      {cards.map(card => (
                        <option key={card.id} value={card.id}>
                          {card.name} (...{card.lastFourDigits})
                        </option>
                      ))}
                    </select>
                    <input
                      type="text"
                      placeholder="Description"
                      value={newTransaction.description}
                      onChange={(e) => setNewTransaction({...newTransaction, description: e.target.value})}
                      className="w-full p-3 border border-gray-300 rounded-lg"
                    />
                    <input
                      type="number"
                      placeholder="Amount"
                      value={newTransaction.amount}
                      onChange={(e) => setNewTransaction({...newTransaction, amount: e.target.value})}
                      className="w-full p-3 border border-gray-300 rounded-lg"
                    />
                    <select
                      value={newTransaction.type}
                      onChange={(e) => setNewTransaction({...newTransaction, type: e.target.value})}
                      className="w-full p-3 border border-gray-300 rounded-lg"
                    >
                      <option value="expense">Expense</option>
                      <option value="payment">Payment</option>
                    </select>
                    <select
                      value={newTransaction.category}
                      onChange={(e) => setNewTransaction({...newTransaction, category: e.target.value})}
                      className="w-full p-3 border border-gray-300 rounded-lg"
                    >
                      {categories.map(cat => (
                        <option key={cat} value={cat}>
                          {cat.charAt(0).toUpperCase() + cat.slice(1)}
                        </option>
                      ))}
                    </select>
                    <input
                      type="date"
                      value={newTransaction.date}
                      onChange={(e) => setNewTransaction({...newTransaction, date: e.target.value})}
                      className="w-full p-3 border border-gray-300 rounded-lg"
                    />
                    <div className="flex gap-2">
                      <button
                        onClick={addTransaction}
                        className="flex-1 bg-green-500 text-white py-2 rounded-lg hover:bg-green-600"
                      >
                        Add Transaction
                      </button>
                      <button
                        onClick={() => setShowAddTransaction(false)}
                        className="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600"
                      >
                        Cancel
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        )}
      </div>

      {/* Summary Stats */}
      {cards.length > 0 && (
        <div className="fixed bottom-0 left-0 right-0 bg-white border-t p-4">
          <div className="grid grid-cols-3 gap-4 text-center">
            <div>
              <div className="text-lg font-semibold text-blue-600">
                ₹{cards.reduce((sum, card) => sum + card.currentBalance, 0).toLocaleString()}
              </div>
              <div className="text-xs text-gray-500">Total Balance</div>
            </div>
            <div>
              <div className="text-lg font-semibold text-green-600">
                ₹{cards.reduce((sum, card) => sum + card.creditLimit, 0).toLocaleString()}
              </div>
              <div className="text-xs text-gray-500">Total Limit</div>
            </div>
            <div>
              <div className="text-lg font-semibold text-purple-600">
                {cards.length}
              </div>
              <div className="text-xs text-gray-500">Cards</div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default CreditCardTracker;
